<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakura Blade: Endless Gacha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Zen+Maru+Gothic:wght@500;700&display=swap');
        
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #1a0b2e; /* Dark Purple Background */
            color: #fce7f3; /* Pinkish Text */
            overflow: hidden;
        }

        h1, h2, h3, .anime-font {
            font-family: 'Zen Maru Gothic', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #2e1065; }
        ::-webkit-scrollbar-thumb { background: #d946ef; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f0abfc; }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(46, 16, 101, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(244, 114, 182, 0.1);
        }
        .glass-panel {
            background: rgba(23, 10, 48, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(236, 72, 153, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(236, 72, 153, 0.2); }
            50% { box-shadow: 0 0 25px rgba(236, 72, 153, 0.6); }
        }
        .glow-effect { animation: pulse-glow 2s infinite; }

        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .shiny-btn { position: relative; overflow: hidden; }
        .shiny-btn::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.5s;
        }
        .shiny-btn:hover::after { animation: shine 1s; }

        @keyframes summon-flash {
            0% { opacity: 0; transform: scale(0.5) rotate(-10deg); }
            50% { opacity: 1; transform: scale(1.1) rotate(5deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); }
        }
        .summon-item { animation: summon-flash 0.5s ease-out forwards; }

        /* Rarity Colors */
        .rarity-3 { color: #bfdbfe; border-color: #60a5fa; box-shadow: 0 0 5px #60a5fa; } /* R - Blue */
        .rarity-4 { color: #f0abfc; border-color: #d946ef; box-shadow: 0 0 10px #d946ef; } /* SR - Pink */
        .rarity-5 { color: #fde047; border-color: #fbbf24; box-shadow: 0 0 15px #fbbf24; } /* SSR - Gold */

        .bg-rarity-3 { background: linear-gradient(135deg, #1e3a8a, #172554); }
        .bg-rarity-4 { background: linear-gradient(135deg, #831843, #500724); }
        .bg-rarity-5 { background: linear-gradient(135deg, #854d0e, #422006); }

        .hidden { display: none !important; }
        .hp-fill { transition: width 0.2s ease-out; }
        
        /* Nav Active State */
        .nav-btn.active { color: #f472b6; transform: scale(1.1); }
        .nav-btn.active i { text-shadow: 0 0 10px #f472b6; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- TOP BAR -->
    <header class="h-16 shrink-0 glass flex items-center justify-between px-6 z-20 relative border-b border-pink-500/20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center font-bold text-xl shadow-lg border-2 border-white/20">ðŸŒ¸</div>
            <div>
                <h1 class="font-bold text-lg leading-tight tracking-wide text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-300">SAKURA BLADE</h1>
                <div class="text-[10px] text-pink-300/70 tracking-widest uppercase">Waifu Collection RPG</div>
            </div>
        </div>
        
        <div class="flex gap-3">
            <!-- Gold -->
            <div class="glass px-3 py-1 rounded-full flex items-center gap-2 border border-pink-500/30">
                <i class="fa-solid fa-coins text-yellow-400"></i>
                <span id="display-gold" class="font-mono font-bold text-sm text-yellow-100">0</span>
            </div>
            <!-- Gems -->
            <div class="glass px-3 py-1 rounded-full flex items-center gap-2 border border-pink-500/30">
                <i class="fa-regular fa-gem text-cyan-300"></i>
                <span id="display-gems" class="font-mono font-bold text-sm text-cyan-100">0</span>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 relative overflow-hidden bg-[url('https://images.unsplash.com/photo-1590252973641-135277488838?q=80&w=2605&auto=format&fit=crop')] bg-cover bg-center">
        <!-- Overlay for darker/purple tint -->
        <div class="absolute inset-0 bg-indigo-950/80 backdrop-blur-[2px]"></div>

        <!-- BATTLE VIEW -->
        <div id="view-battle" class="view-section absolute inset-0 flex flex-col p-4">
            <div class="text-center mb-2 z-10">
                <span class="bg-pink-900/80 border border-pink-500/50 px-6 py-1 rounded-full text-xs font-bold tracking-[0.2em] text-pink-200 uppercase shadow-lg shadow-pink-500/20">Current Zone</span>
                <h2 class="text-4xl font-black text-white drop-shadow-[0_0_10px_rgba(236,72,153,0.8)] mt-2" id="stage-name">Tokyo</h2>
                <div class="text-sm text-pink-200 mt-1 font-bold">Wave <span id="wave-num" class="text-xl">1</span></div>
            </div>

            <div class="flex-1 flex items-center justify-center gap-2 lg:gap-12 relative">
                <!-- Heroes -->
                <div class="flex flex-col gap-3 w-1/3 max-w-sm justify-center" id="battle-heroes-container"></div>
                
                <!-- VS -->
                <div class="text-7xl font-black text-white/10 absolute pointer-events-none select-none italic z-0">VS</div>

                <!-- Enemies -->
                <div class="flex flex-col gap-3 w-1/3 max-w-sm items-end justify-center" id="battle-enemies-container"></div>
            </div>

            <div class="h-32 glass-panel rounded-xl mt-4 p-3 overflow-hidden flex flex-col border-t-2 border-pink-500/30">
                <div class="text-[10px] font-bold text-pink-400 uppercase mb-1 tracking-wider">Combat Log</div>
                <div id="battle-log" class="flex-1 overflow-y-auto font-mono text-[10px] text-purple-200 space-y-1">
                    <div class="text-pink-400">Battle Start...</div>
                </div>
            </div>
        </div>

        <!-- HEROES VIEW -->
        <div id="view-heroes" class="view-section hidden absolute inset-0 p-6 overflow-y-auto pb-24">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-white anime-font">My Waifus</h2>
                    <p class="text-pink-300/60 text-sm">Manage your team of battle maidens.</p>
                </div>
                <button onclick="game.autoEquip()" class="bg-gradient-to-r from-pink-600 to-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-pink-500/30 hover:scale-105 transition"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Auto Team</button>
            </div>

            <div class="mb-8 p-4 glass rounded-2xl border border-pink-500/30 bg-pink-900/20">
                <h3 class="text-sm font-bold text-pink-300 uppercase tracking-wider mb-3 flex items-center gap-2"><i class="fa-solid fa-crown"></i> Main Squad</h3>
                <div class="grid grid-cols-4 gap-2 md:gap-4" id="team-slots"></div>
            </div>

            <h3 class="text-sm font-bold text-purple-300 uppercase tracking-wider mb-3">Dormitory (Collection)</h3>
            <div class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-6 gap-3" id="hero-collection"></div>
        </div>

        <!-- SUMMON VIEW -->
        <div id="view-summon" class="view-section hidden absolute inset-0 flex flex-col items-center justify-center p-6 bg-indigo-950/95 z-30">
            <div class="w-full max-w-4xl text-center relative z-10">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-pink-500/20 rounded-full blur-[100px] -z-10"></div>
                
                <h2 class="text-5xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white via-pink-200 to-pink-500 mb-2 drop-shadow-sm filter anime-font italic">DIVINE SUMMON</h2>
                <p class="text-pink-300 mb-8 font-light tracking-wide">Call forth legendary maidens from the Spirit Realm</p>
                
                <!-- Banner Art -->
                <div class="w-full h-56 md:h-72 bg-gradient-to-r from-pink-900 to-purple-900 rounded-2xl border-2 border-pink-400/30 shadow-[0_0_30px_rgba(236,72,153,0.3)] flex items-center justify-center mb-8 overflow-hidden relative group">
                    <img src="https://images.unsplash.com/photo-1620559982460-752e1858c894?q=80&w=2670&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 mix-blend-overlay group-hover:scale-110 transition duration-[2s]">
                    <div class="z-10 text-center">
                        <div class="text-5xl text-white font-black italic transform -rotate-3 drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)]">SSR RATE UP!</div>
                        <div class="text-lg text-yellow-300 font-bold mt-2 bg-black/40 px-4 py-1 rounded-full backdrop-blur-sm border border-yellow-500/50">âœ¨ Legendary Maidens Available âœ¨</div>
                    </div>
                </div>

                <div class="flex gap-4 justify-center">
                    <button onclick="game.pullGacha(1)" class="shiny-btn glass-panel px-6 py-4 rounded-xl hover:bg-white/5 hover:scale-105 transition transform flex flex-col items-center gap-1 w-36 group border-pink-700/50">
                        <span class="text-base font-bold text-pink-100">Summon x1</span>
                        <div class="flex items-center gap-2 text-xs text-cyan-300 bg-black/40 px-3 py-1 rounded-full">
                            <i class="fa-regular fa-gem"></i> 160
                        </div>
                    </button>

                    <button onclick="game.pullGacha(10)" class="shiny-btn relative overflow-hidden bg-gradient-to-br from-pink-600 to-purple-700 px-6 py-4 rounded-xl shadow-lg shadow-pink-900/50 hover:scale-105 transition transform flex flex-col items-center gap-1 w-44 border border-pink-400">
                        <span class="text-lg font-bold text-white">Summon x10</span>
                        <div class="flex items-center gap-2 text-xs text-yellow-100 bg-black/20 px-3 py-1 rounded-full">
                            <i class="fa-regular fa-gem"></i> 1600
                        </div>
                        <div class="absolute top-0 right-0 bg-yellow-400 text-pink-900 text-[9px] font-bold px-2 py-0.5 rounded-bl-lg">SR+ GUARANTEED</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- SHOP VIEW -->
        <div id="view-shop" class="view-section hidden absolute inset-0 p-6 overflow-y-auto pb-24">
            <h2 class="text-3xl font-bold text-white mb-6 anime-font">Neko Shop</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- ATK -->
                <div class="glass-panel p-6 rounded-xl flex flex-col gap-4 border-t-4 border-red-500">
                    <div class="flex justify-between items-start">
                        <div class="w-12 h-12 rounded-lg bg-red-500/20 flex items-center justify-center text-red-400 text-2xl"><i class="fa-solid fa-fire"></i></div>
                        <div class="text-xs text-pink-200">Lvl <span id="shop-atk-lvl">0</span></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-white">Blade Sharpening</h3>
                        <p class="text-sm text-pink-300/60">Increases Global ATK.</p>
                    </div>
                    <button onclick="game.buyUpgrade('atk')" class="mt-auto bg-slate-800 hover:bg-slate-700 py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition border border-slate-600">
                        <i class="fa-solid fa-coins text-yellow-400"></i> <span id="shop-atk-cost">100</span>
                    </button>
                </div>

                <!-- HP -->
                <div class="glass-panel p-6 rounded-xl flex flex-col gap-4 border-t-4 border-green-500">
                    <div class="flex justify-between items-start">
                        <div class="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center text-green-400 text-2xl"><i class="fa-solid fa-heart"></i></div>
                        <div class="text-xs text-pink-200">Lvl <span id="shop-hp-lvl">0</span></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-white">Spirit Blessing</h3>
                        <p class="text-sm text-pink-300/60">Increases Global HP.</p>
                    </div>
                    <button onclick="game.buyUpgrade('hp')" class="mt-auto bg-slate-800 hover:bg-slate-700 py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition border border-slate-600">
                        <i class="fa-solid fa-coins text-yellow-400"></i> <span id="shop-hp-cost">100</span>
                    </button>
                </div>

                 <!-- GOLD -->
                 <div class="glass-panel p-6 rounded-xl flex flex-col gap-4 border-t-4 border-yellow-500">
                    <div class="flex justify-between items-start">
                        <div class="w-12 h-12 rounded-lg bg-yellow-500/20 flex items-center justify-center text-yellow-400 text-2xl"><i class="fa-solid fa-sack-dollar"></i></div>
                        <div class="text-xs text-pink-200">Lvl <span id="shop-gold-lvl">0</span></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-white">Fortune Cat</h3>
                        <p class="text-sm text-pink-300/60">Increases Gold Gain.</p>
                    </div>
                    <button onclick="game.buyUpgrade('gold')" class="mt-auto bg-slate-800 hover:bg-slate-700 py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition border border-slate-600">
                        <i class="fa-solid fa-coins text-yellow-400"></i> <span id="shop-gold-cost">200</span>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- BOTTOM NAV -->
    <nav class="h-20 shrink-0 glass border-t border-pink-500/20 z-50 bg-indigo-950/90">
        <div class="max-w-md mx-auto h-full flex justify-between px-6 relative">
            <button onclick="ui.switchView('battle')" class="nav-btn active flex flex-col items-center justify-center gap-1 text-purple-300 hover:text-white transition w-16" data-target="view-battle">
                <i class="fa-solid fa-dungeon text-xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase tracking-wider">Battle</span>
            </button>
            <button onclick="ui.switchView('heroes')" class="nav-btn flex flex-col items-center justify-center gap-1 text-purple-300 hover:text-white transition w-16" data-target="view-heroes">
                <i class="fa-solid fa-users text-xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase tracking-wider">Waifus</span>
            </button>
            
            <!-- Summon Button -->
            <div class="relative -top-8 group">
                <button onclick="ui.switchView('summon')" class="w-20 h-20 rounded-full bg-gradient-to-br from-pink-500 via-red-500 to-purple-600 shadow-[0_0_20px_rgba(236,72,153,0.6)] flex items-center justify-center border-[6px] border-[#1a0b2e] transform group-hover:scale-110 transition duration-300 overflow-hidden relative">
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-50"></div>
                    <i class="fa-solid fa-star text-white text-3xl animate-[spin_10s_linear_infinite]"></i>
                </button>
                <div class="absolute -bottom-4 left-1/2 -translate-x-1/2 text-[10px] font-bold text-pink-400 bg-black/60 px-2 rounded-full whitespace-nowrap">SUMMON</div>
            </div>

            <button onclick="ui.switchView('shop')" class="nav-btn flex flex-col items-center justify-center gap-1 text-purple-300 hover:text-white transition w-16" data-target="view-shop">
                <i class="fa-solid fa-shop text-xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase tracking-wider">Shop</span>
            </button>
            <button onclick="game.resetData()" class="nav-btn flex flex-col items-center justify-center gap-1 text-purple-300 hover:text-red-400 transition w-16">
                <i class="fa-solid fa-trash-can text-xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase tracking-wider">Reset</span>
            </button>
        </div>
    </nav>

    <!-- MODALS -->
    <!-- GACHA RESULTS -->
    <div id="modal-gacha-results" class="hidden fixed inset-0 z-[60] bg-black/95 flex flex-col items-center justify-center p-4">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')] opacity-10"></div>
        <h2 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-purple-300 mb-8 tracking-widest uppercase animate-bounce">Summon Successful!</h2>
        <div id="gacha-grid" class="flex flex-wrap justify-center gap-4 max-w-4xl z-10"></div>
        <button onclick="ui.closeGachaModal()" class="mt-12 bg-white text-black px-12 py-3 rounded-full font-bold hover:bg-pink-100 transition shadow-[0_0_20px_white]">CONFIRM</button>
    </div>

    <!-- HERO DETAIL -->
    <div id="modal-hero-detail" class="hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg rounded-2xl p-6 relative border-t border-pink-500/50 shadow-[0_0_50px_rgba(236,72,153,0.2)]">
            <button onclick="ui.closeHeroModal()" class="absolute top-4 right-4 text-pink-400 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
            
            <div class="flex gap-6 items-start">
                <div id="detail-img-container" class="w-28 h-28 rounded-xl shrink-0 overflow-hidden border-2 border-white/20 shadow-xl"></div>
                <div>
                    <h2 id="detail-name" class="text-3xl font-bold text-white anime-font">Name</h2>
                    <div id="detail-rarity" class="flex gap-1 text-sm my-1 text-yellow-400"></div>
                    <div id="detail-class" class="text-[10px] text-pink-200 uppercase tracking-wider bg-pink-500/20 inline-block px-3 py-1 rounded-full mt-1 border border-pink-500/30">Class</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-6">
                <div class="bg-black/30 p-3 rounded-lg border border-pink-500/10">
                    <div class="text-pink-400 text-xs uppercase font-bold">Attack Power</div>
                    <div id="detail-atk" class="text-2xl font-mono font-bold text-white">0</div>
                </div>
                <div class="bg-black/30 p-3 rounded-lg border border-pink-500/10">
                    <div class="text-green-400 text-xs uppercase font-bold">Hit Points</div>
                    <div id="detail-hp" class="text-2xl font-mono font-bold text-white">0</div>
                </div>
            </div>

            <div class="mt-6 bg-white/5 p-4 rounded-xl">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-pink-200">Current Level: <span id="detail-level" class="text-white font-bold">1</span></span>
                    <span class="text-yellow-400 font-bold" id="detail-stars"></span>
                </div>
                <button id="btn-upgrade-hero" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 py-3 rounded-xl font-bold text-white transition shadow-lg flex items-center justify-center gap-2">
                    Upgrade
                </button>
                <div class="mt-2 text-center text-[10px] text-pink-300/50">Enhance stats by 10% per level</div>
            </div>
            
            <div class="mt-4">
                <button id="btn-equip-hero" class="w-full border-2 border-pink-500/30 hover:bg-pink-500/20 py-3 rounded-xl font-bold text-sm text-pink-200 transition">Equip to Team</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-indigo-900 border border-pink-500 text-white px-6 py-3 rounded-full shadow-[0_0_20px_rgba(236,72,153,0.4)] z-[70] transition-all duration-300 opacity-0 pointer-events-none flex items-center gap-3">
        <i id="toast-icon" class="fa-solid fa-circle-info"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const ELEMENTS = {
            FIRE: { color: 'text-red-400', bg: 'bg-red-900/50', border: 'border-red-500', icon: 'fa-fire' },
            WATER: { color: 'text-blue-400', bg: 'bg-blue-900/50', border: 'border-blue-500', icon: 'fa-droplet' },
            WIND: { color: 'text-green-400', bg: 'bg-green-900/50', border: 'border-green-500', icon: 'fa-wind' },
            LIGHT: { color: 'text-yellow-200', bg: 'bg-yellow-900/50', border: 'border-yellow-500', icon: 'fa-sun' },
            DARK: { color: 'text-purple-400', bg: 'bg-purple-900/50', border: 'border-purple-500', icon: 'fa-moon' }
        };

        const ROLES = {
            TANK: { label: 'Guardian', icon: 'fa-shield-heart' },
            DPS: { label: 'Striker', icon: 'fa-khanda' },
            HEALER: { label: 'Priestess', icon: 'fa-heart' },
            SUPPORT: { label: 'Enchantress', icon: 'fa-wand-sparkles' }
        };

        // 50+ Anime Girls Names
        const ANIME_NAMES = [
            "Sakura", "Aoi", "Rin", "Mio", "Yuki", "Hana", "Akane", "Hikari", "Rei", "Asuka", 
            "Nami", "Mikasa", "Hinata", "Saber", "Kaguya", "Rem", "Ram", "Megumin", "Aqua", "Zero Two",
            "Nezuko", "Shinobu", "Mitsuri", "Yor", "Makima", "Power", "Fubuki", "Tatsumaki", "Mai", "Kurisu",
            "Touka", "Rias", "Akeno", "Erza", "Lucy", "Mirajane", "Yuno", "Esdeath", "Akame", "Raphtalia",
            "Holo", "Senjougahara", "Chitoge", "Taiga", "Minori", "Ami", "Yui", "Azusa", "Mugi", "Ritsu",
            "Satsuki", "Ryuko", "Mako", "Nui", "Ragyo", "Violet", "Cattleya", "Iris", "Erica", "Alice"
        ];

        const TITLES = [
            "Blade Dancer", "Spirit Caller", "Shrine Maiden", "Void Witch", "Dragon Tamer",
            "Moon Princess", "Sun Goddess", "Shadow Assassin", "Frost Queen", "Flame Empress",
            "Storm Bringer", "Divine Healer", "Chaos Walker", "Star Gazer", "Ocean Soul"
        ];

        // Generate Character DB
        const generateDB = () => {
            let db = [];
            for (let i = 0; i < ANIME_NAMES.length; i++) {
                const name = ANIME_NAMES[i];
                const title = TITLES[i % TITLES.length];
                // Determine stats based on index logic for variety
                const rarityRoll = Math.random();
                let rarity = 3;
                if (rarityRoll > 0.9) rarity = 5;
                else if (rarityRoll > 0.7) rarity = 4;

                const elements = ['FIRE', 'WATER', 'WIND', 'LIGHT', 'DARK'];
                const roles = ['DPS', 'TANK', 'HEALER', 'SUPPORT'];
                const element = elements[i % 5];
                const role = roles[i % 4];

                let baseHp = 800 + (rarity * 200) + (role === 'TANK' ? 500 : 0);
                let baseAtk = 50 + (rarity * 20) + (role === 'DPS' ? 40 : 0);

                db.push({
                    id: i + 1,
                    name: `${name}, ${title}`,
                    shortName: name,
                    rarity: rarity,
                    element: element,
                    role: role,
                    baseAtk: Math.floor(baseAtk),
                    baseHp: Math.floor(baseHp)
                });
            }
            return db;
        };

        const CHARACTER_DB = generateDB();

        // --- STATE MANAGEMENT ---
        const gameState = {
            gold: 0,
            gems: 1000,
            inventory: {}, 
            team: [null, null, null, null],
            upgrades: { atk: 0, hp: 0, gold: 0 },
            stage: 1,
            wave: 1
        };

        const battleState = {
            active: true,
            heroes: [],
            enemies: [],
            enemySpawnTimer: 0
        };

        // --- UTILS ---
        const saveGame = () => localStorage.setItem('sakura_blade_save', JSON.stringify(gameState));
        const loadGame = () => {
            const save = localStorage.getItem('sakura_blade_save');
            if (save) Object.assign(gameState, JSON.parse(save));
            ui.updateCurrency();
        };
        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        // Anime Avatar Generator
        const getAvatar = (hero, size="md") => {
            const sizes = { sm: "w-8 h-8 text-[10px]", md: "w-12 h-12 text-xs", lg: "w-20 h-20 text-xl", xl: "w-full h-full text-4xl" };
            const elData = ELEMENTS[hero.element];
            
            // Soft gradient backgrounds based on element
            const gradients = {
                FIRE: 'from-red-400 to-pink-500',
                WATER: 'from-blue-400 to-cyan-500',
                WIND: 'from-green-400 to-emerald-500',
                LIGHT: 'from-yellow-200 to-orange-300',
                DARK: 'from-purple-500 to-indigo-700'
            };

            const initials = hero.shortName.substring(0, 1);
            const imgPath = `./images/${hero.id}.png`;
            
            return `
                <div class="${sizes[size]} rounded-lg bg-gradient-to-br ${gradients[hero.element]} p-[2px] shadow-lg relative shrink-0">
                    <div class="w-full h-full bg-black/20 backdrop-blur-[1px] rounded-md flex items-center justify-center font-bold text-white overflow-hidden relative">
                         <img src="${imgPath}" class="absolute inset-0 w-full h-full object-cover z-10" onerror="this.style.display='none'">
                         <span class="z-0 drop-shadow-md anime-font">${initials}</span>
                    </div>
                    <div class="absolute -top-1 -right-1 w-3 h-3 rounded-full border border-white ${elData.bg} z-20"></div>
                </div>
            `;
        };

        // --- CORE LOGIC ---
        const game = {
            init: () => {
                loadGame();
                ui.init();
                
                // FIX: Ensure wave is 1 on load if empty, and spawn FIRST before loop starts
                if(battleState.enemies.length === 0) {
                    gameState.wave = 1;
                    game.spawnEnemy(); 
                }
                
                game.setupBattleTeam();
                game.startBattleLoop();
                setInterval(saveGame, 5000);
            },

            resetData: () => {
                if(confirm("Reset all progress?")) {
                    localStorage.removeItem('sakura_blade_save');
                    location.reload();
                }
            },

            pullGacha: (amount) => {
                const cost = amount * 160;
                if (gameState.gems < cost) {
                    ui.toast("Not enough Gems!", "error");
                    return;
                }

                gameState.gems -= cost;
                ui.updateCurrency();
                
                const results = [];
                for (let i = 0; i < amount; i++) {
                    const roll = Math.random();
                    let rarity = 3;
                    if (roll < 0.05) rarity = 5; 
                    else if (roll < 0.20) rarity = 4;
                    
                    const pool = CHARACTER_DB.filter(c => c.rarity === rarity);
                    const hero = pool[Math.floor(Math.random() * pool.length)];
                    results.push(hero);

                    if (!gameState.inventory[hero.id]) {
                        gameState.inventory[hero.id] = { level: 1, stars: 1, id: hero.id };
                    } else {
                        gameState.inventory[hero.id].stars++;
                    }
                }

                ui.showGachaResults(results);
                saveGame();
            },

            buyUpgrade: (type) => {
                const costs = {
                    atk: 100 * Math.pow(1.5, gameState.upgrades.atk),
                    hp: 100 * Math.pow(1.5, gameState.upgrades.hp),
                    gold: 200 * Math.pow(1.5, gameState.upgrades.gold)
                };
                
                const cost = Math.floor(costs[type]);
                if (gameState.gold >= cost) {
                    gameState.gold -= cost;
                    gameState.upgrades[type]++;
                    ui.updateCurrency();
                    ui.updateShop();
                    game.setupBattleTeam(); // Updates stats live
                } else {
                    ui.toast("Not enough Gold!", "error");
                }
            },

            upgradeHero: (heroId) => {
                const data = gameState.inventory[heroId];
                if (!data) return;
                
                const cost = Math.floor(50 * Math.pow(1.2, data.level));
                if (gameState.gold >= cost) {
                    gameState.gold -= cost;
                    data.level++;
                    ui.updateCurrency();
                    ui.openHeroModal(heroId);
                    game.setupBattleTeam();
                } else {
                    ui.toast("Need " + cost + " Gold", "error");
                }
            },

            equipHero: (heroId) => {
                const emptyIdx = gameState.team.indexOf(null);
                if (emptyIdx !== -1) {
                    gameState.team[emptyIdx] = heroId;
                } else {
                    gameState.team.shift();
                    gameState.team.push(heroId);
                }
                saveGame();
                ui.renderHeroes();
                ui.toast("Maiden equipped!");
                game.setupBattleTeam();
            },
            
            autoEquip: () => {
                const owned = Object.values(gameState.inventory);
                if (owned.length === 0) return;
                
                owned.sort((a, b) => {
                    const heroA = CHARACTER_DB.find(h => h.id === a.id);
                    const heroB = CHARACTER_DB.find(h => h.id === b.id);
                    return (heroB.rarity - heroA.rarity) || (b.level - a.level);
                });

                gameState.team = [null, null, null, null];
                for(let i=0; i<4 && i<owned.length; i++) {
                    gameState.team[i] = owned[i].id;
                }
                saveGame();
                ui.renderHeroes();
                ui.toast("Strongest waifus equipped!");
                game.setupBattleTeam();
            },

            setupBattleTeam: () => {
                // Preserve current HP ratios if possible, otherwise full heal
                // For simplicity in this fix, we just rebuild.
                const oldHeroes = battleState.heroes;
                battleState.heroes = [];

                gameState.team.forEach(id => {
                    if (id && gameState.inventory[id]) {
                        const base = CHARACTER_DB.find(c => c.id === id);
                        const inv = gameState.inventory[id];
                        
                        const starMult = 1 + (inv.stars - 1) * 0.2;
                        const lvlMult = 1 + (inv.level - 1) * 0.1;
                        const globalAtkMult = 1 + (gameState.upgrades.atk * 0.1);
                        const globalHpMult = 1 + (gameState.upgrades.hp * 0.1);

                        const maxHp = Math.floor(base.baseHp * lvlMult * starMult * globalHpMult);
                        const atk = Math.floor(base.baseAtk * lvlMult * starMult * globalAtkMult);

                        // Try to find existing instance to keep HP
                        const existing = oldHeroes.find(h => h.id === id);
                        let currentHp = maxHp;
                        if (existing && existing.hp > 0) {
                            currentHp = Math.min(maxHp, existing.hp); 
                        }

                        battleState.heroes.push({
                            ...base,
                            instanceId: Math.random(),
                            level: inv.level,
                            maxHp: maxHp,
                            hp: currentHp,
                            atk: atk,
                            cd: existing ? existing.cd : 0,
                            maxCd: 100
                        });
                    }
                });
                ui.renderBattleField();
            },

            spawnEnemy: () => {
                if (battleState.enemies.length >= 3) return;

                const stageMult = Math.pow(1.15, gameState.stage + (gameState.wave * 0.05));
                const hp = Math.floor(500 * stageMult);
                const atk = Math.floor(20 * stageMult);
                
                // Anime Enemy Names
                const mobs = ["Slime", "Goblin", "Orc", "Spirit", "Demon", "Mecha", "Ninja"];
                const name = mobs[gameState.stage % mobs.length] + " Lv." + (gameState.stage * 10 + gameState.wave);

                battleState.enemies.push({
                    name: name,
                    maxHp: hp,
                    hp: hp,
                    atk: atk,
                    cd: randomInt(0, 50),
                    maxCd: 120,
                    instanceId: Math.random()
                });
                ui.renderBattleField();
            },

            startBattleLoop: () => {
                const tickRate = 50; 
                
                setInterval(() => {
                    if (!battleState.active) return;
                    
                    // Wave Logic
                    if (battleState.enemies.length === 0) {
                        if (battleState.enemySpawnTimer <= 0) {
                            gameState.wave++;
                            if (gameState.wave > 10) {
                                gameState.stage++;
                                gameState.wave = 1;
                                ui.toast(`Zone ${gameState.stage} Reached!`);
                            }
                            ui.updateStageDisplay();
                            
                            // Spawn logic
                            const count = randomInt(1, 3);
                            for(let i=0; i<count; i++) game.spawnEnemy();
                            
                            // Reset timer
                            battleState.enemySpawnTimer = 0; 
                            
                            // Revive dead heroes slightly on new wave?
                            battleState.heroes.forEach(h => {
                                if(h.hp <= 0) h.hp = Math.floor(h.maxHp * 0.5); // Revive with 50% HP
                            });

                        } else {
                             // Wait a bit before next wave
                             // Actually, simpler: spawn immediately if empty, don't use timer for now to keep it fast
                        }
                    }

                    // Hero Logic
                    battleState.heroes.forEach(h => {
                        if (h.hp <= 0) return;
                        h.cd += 5; 
                        if (h.cd >= h.maxCd) {
                            h.cd = 0;
                            const target = battleState.enemies[randomInt(0, battleState.enemies.length - 1)];
                            if (target) {
                                target.hp -= h.atk;
                                ui.showDamage(target.instanceId, h.atk, 'crit'); 
                                ui.animateAttack(h.instanceId, 'hero');
                                if (target.hp <= 0) {
                                    const goldGain = Math.floor(10 * (1 + gameState.upgrades.gold * 0.2) * (1 + gameState.stage * 0.1));
                                    gameState.gold += goldGain;
                                    ui.updateCurrency();
                                    battleState.enemies = battleState.enemies.filter(e => e !== target);
                                    ui.renderBattleField();
                                }
                            }
                        }
                    });

                    // Enemy Logic
                    battleState.enemies.forEach(e => {
                        if (e.hp <= 0) return;
                        e.cd += 3;
                        if (e.cd >= e.maxCd) {
                            e.cd = 0;
                            const validHeroes = battleState.heroes.filter(h => h.hp > 0);
                            const target = validHeroes[randomInt(0, validHeroes.length - 1)];
                            if (target) {
                                target.hp -= e.atk;
                                ui.showDamage(target.instanceId, e.atk, 'normal');
                                ui.animateAttack(e.instanceId, 'enemy');
                                if (target.hp <= 0) {
                                    // Hero dies
                                }
                            }
                        }
                    });

                    // Check Wipe
                    if (battleState.heroes.length > 0 && battleState.heroes.every(h => h.hp <= 0)) {
                        ui.log("All waifus defeated! Retreating...", "text-red-400");
                        gameState.wave = Math.max(1, gameState.wave - 1);
                        battleState.enemies = []; 
                        // Full revive
                        game.setupBattleTeam(); 
                        battleState.heroes.forEach(h => h.hp = h.maxHp);
                    }

                    ui.updateBattleBars();

                }, tickRate);
            }
        };

        // --- UI RENDERER ---
        const ui = {
            init: () => {
                ui.renderHeroes();
                ui.updateCurrency();
                ui.updateShop();
                ui.updateStageDisplay();
            },

            // FIX: Robust Switch View
            switchView: (viewName) => {
                // Hide all
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                // Show target
                const targetEl = document.getElementById(`view-${viewName}`);
                if(targetEl) targetEl.classList.remove('hidden');
                
                // Update Nav UI
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('active', 'text-pink-400');
                    b.classList.add('text-purple-300');
                });
                
                // Highlight button if exists
                const navBtn = document.querySelector(`[data-target="view-${viewName}"]`);
                if(navBtn) {
                    navBtn.classList.add('active', 'text-pink-400');
                    navBtn.classList.remove('text-purple-300');
                }
            },

            toast: (msg, type="info") => {
                const el = document.getElementById('toast');
                const txt = document.getElementById('toast-msg');
                const icon = document.getElementById('toast-icon');
                
                txt.innerText = msg;
                el.classList.remove('opacity-0', 'top-20');
                el.classList.add('opacity-100', 'top-24');
                
                if (type === 'error') {
                    icon.className = "fa-solid fa-circle-exclamation text-red-400";
                    el.classList.add('border-red-500');
                } else {
                    icon.className = "fa-solid fa-circle-check text-green-400";
                    el.classList.remove('border-red-500');
                }

                setTimeout(() => {
                    el.classList.add('opacity-0', 'top-20');
                    el.classList.remove('opacity-100', 'top-24');
                }, 2000);
            },

            updateCurrency: () => {
                document.getElementById('display-gold').innerText = gameState.gold.toLocaleString();
                document.getElementById('display-gems').innerText = gameState.gems.toLocaleString();
            },

            updateStageDisplay: () => {
                const zones = ["Tokyo", "Kyoto", "Osaka", "Hokkaido", "Okinawa", "Akihabara"];
                const zoneName = zones[(gameState.stage - 1) % zones.length];
                document.getElementById('stage-name').innerText = `${zoneName} (${gameState.stage})`;
                document.getElementById('wave-num').innerText = gameState.wave + "/10";
            },

            renderHeroes: () => {
                const container = document.getElementById('hero-collection');
                const teamSlots = document.getElementById('team-slots');
                container.innerHTML = '';
                teamSlots.innerHTML = '';

                // Team
                for(let i=0; i<4; i++) {
                    const heroId = gameState.team[i];
                    if (heroId) {
                        const hero = CHARACTER_DB.find(c => c.id === heroId);
                        const inv = gameState.inventory[heroId];
                        teamSlots.innerHTML += `
                            <div class="glass p-2 rounded-lg flex flex-col items-center relative group cursor-pointer border border-pink-500/30 hover:bg-pink-500/10" onclick="ui.openHeroModal(${hero.id})">
                                ${getAvatar(hero, 'md')}
                                <div class="text-[10px] mt-1 font-bold truncate w-full text-center text-pink-200">${hero.shortName}</div>
                                <div class="absolute top-0 right-0 bg-pink-600 text-white text-[9px] px-1 rounded-bl shadow-sm">Lv.${inv.level}</div>
                            </div>
                        `;
                    } else {
                        teamSlots.innerHTML += `
                            <div class="glass p-2 rounded-lg flex flex-col items-center justify-center border border-dashed border-pink-500/30 opacity-50">
                                <i class="fa-solid fa-plus text-pink-300"></i>
                            </div>
                        `;
                    }
                }

                // Collection
                const owned = Object.values(gameState.inventory);
                owned.sort((a,b) => {
                    const ha = CHARACTER_DB.find(c=>c.id === a.id);
                    const hb = CHARACTER_DB.find(c=>c.id === b.id);
                    return hb.rarity - ha.rarity;
                });

                owned.forEach(item => {
                    const hero = CHARACTER_DB.find(c => c.id === item.id);
                    const isEquipped = gameState.team.includes(hero.id);
                    
                    const card = document.createElement('div');
                    card.className = `glass p-2 rounded-xl flex flex-col items-center relative cursor-pointer hover:scale-105 transition duration-200 ${isEquipped ? 'border-pink-500 border-2 shadow-[0_0_10px_pink]' : 'border-white/5'}`;
                    card.onclick = () => ui.openHeroModal(hero.id);
                    card.innerHTML = `
                        ${getAvatar(hero, 'lg')}
                        <div class="mt-1 text-center w-full">
                            <div class="flex justify-center gap-0.5 text-[8px] text-yellow-400 mb-0.5">
                                ${'<i class="fa-solid fa-star"></i>'.repeat(hero.rarity)}
                            </div>
                        </div>
                        <div class="absolute -top-1 -left-1 bg-black/60 px-1.5 rounded-full text-[9px] font-mono text-white border border-white/20">Lv.${item.level}</div>
                    `;
                    container.appendChild(card);
                });
            },

            openHeroModal: (id) => {
                const hero = CHARACTER_DB.find(c => c.id === id);
                const inv = gameState.inventory[id];
                const modal = document.getElementById('modal-hero-detail');
                const btnUp = document.getElementById('btn-upgrade-hero');
                
                // Calculate Stats
                const starMult = 1 + (inv.stars - 1) * 0.2;
                const lvlMult = 1 + (inv.level - 1) * 0.1;
                const globalAtkMult = 1 + (gameState.upgrades.atk * 0.1);
                const globalHpMult = 1 + (gameState.upgrades.hp * 0.1);
                const atk = Math.floor(hero.baseAtk * lvlMult * starMult * globalAtkMult);
                const hp = Math.floor(hero.baseHp * lvlMult * starMult * globalHpMult);
                const upgradeCost = Math.floor(50 * Math.pow(1.2, inv.level));

                document.getElementById('detail-img-container').innerHTML = getAvatar(hero, 'xl');
                document.getElementById('detail-name').innerText = hero.name;
                document.getElementById('detail-rarity').innerHTML = '<i class="fa-solid fa-star"></i>'.repeat(hero.rarity);
                document.getElementById('detail-class').innerText = ROLES[hero.role].label;
                document.getElementById('detail-atk').innerText = atk;
                document.getElementById('detail-hp').innerText = hp;
                document.getElementById('detail-level').innerText = inv.level;
                document.getElementById('detail-stars').innerHTML = `${inv.stars} <i class="fa-solid fa-star-half-stroke text-xs"></i>`;
                
                btnUp.innerHTML = `<div>Level Up</div><div class="text-xs font-normal opacity-80">${upgradeCost} Gold</div>`;
                btnUp.onclick = () => game.upgradeHero(id);

                const btnEq = document.getElementById('btn-equip-hero');
                btnEq.onclick = () => { game.equipHero(id); ui.closeHeroModal(); };
                btnEq.innerText = gameState.team.includes(id) ? "Already in Squad" : "Add to Squad";
                btnEq.disabled = gameState.team.includes(id);
                btnEq.classList.toggle('opacity-50', gameState.team.includes(id));

                modal.classList.remove('hidden');
            },
            
            closeHeroModal: () => {
                document.getElementById('modal-hero-detail').classList.add('hidden');
            },

            showGachaResults: (heroes) => {
                const modal = document.getElementById('modal-gacha-results');
                const grid = document.getElementById('gacha-grid');
                grid.innerHTML = '';
                
                heroes.forEach((h, idx) => {
                    const div = document.createElement('div');
                    div.className = `w-32 h-48 bg-rarity-${h.rarity} rounded-xl p-0.5 shadow-[0_0_20px_currentColor] summon-item opacity-0 transform scale-50`;
                    div.style.animationDelay = `${idx * 150}ms`;
                    
                    div.innerHTML = `
                        <div class="w-full h-full bg-[#1a0b2e] rounded-lg overflow-hidden flex flex-col relative">
                            <div class="h-32 bg-gradient-to-b from-transparent to-black/50 flex items-center justify-center relative">
                                ${getAvatar(h, 'lg')}
                                <div class="absolute top-1 right-1 text-white text-[10px] font-bold bg-black/50 px-1 rounded">
                                    ${h.element.substring(0,3)}
                                </div>
                            </div>
                            <div class="flex-1 p-1 flex flex-col items-center text-center justify-center bg-black/20">
                                <div class="text-[9px] font-bold text-rarity-${h.rarity} uppercase tracking-wider">
                                    ${h.rarity === 5 ? 'SSR' : h.rarity === 4 ? 'SR' : 'R'}
                                </div>
                                <div class="text-xs font-bold text-white leading-tight mt-1 truncate w-full px-1">${h.shortName}</div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(div);
                });

                modal.classList.remove('hidden');
            },

            closeGachaModal: () => {
                document.getElementById('modal-gacha-results').classList.add('hidden');
                ui.renderHeroes();
            },

            updateShop: () => {
                const costs = {
                    atk: 100 * Math.pow(1.5, gameState.upgrades.atk),
                    hp: 100 * Math.pow(1.5, gameState.upgrades.hp),
                    gold: 200 * Math.pow(1.5, gameState.upgrades.gold)
                };
                
                document.getElementById('shop-atk-lvl').innerText = gameState.upgrades.atk;
                document.getElementById('shop-atk-cost').innerText = Math.floor(costs.atk);
                
                document.getElementById('shop-hp-lvl').innerText = gameState.upgrades.hp;
                document.getElementById('shop-hp-cost').innerText = Math.floor(costs.hp);
                
                document.getElementById('shop-gold-lvl').innerText = gameState.upgrades.gold;
                document.getElementById('shop-gold-cost').innerText = Math.floor(costs.gold);
            },

            // BATTLE RENDERER
            renderBattleField: () => {
                const hCont = document.getElementById('battle-heroes-container');
                const eCont = document.getElementById('battle-enemies-container');

                const syncUnits = (container, list, isHero) => {
                    container.innerHTML = ''; 
                    list.forEach(unit => {
                        const el = document.createElement('div');
                        el.id = `unit-${unit.instanceId}`;
                        el.className = `relative transition-all duration-300 transform ${isHero ? 'hover:scale-105' : 'hover:scale-105'} animate-float flex flex-col items-center`;
                        el.style.animationDelay = `${Math.random()}s`;

                        el.innerHTML = `
                            <div class="w-16 h-16 md:w-20 md:h-20 glass rounded-lg border-2 ${isHero ? 'border-pink-400' : 'border-red-500'} flex items-center justify-center shadow-lg relative z-10 overflow-hidden bg-black/40">
                                ${isHero ? getAvatar(unit, 'lg') : '<i class="fa-solid fa-skull text-3xl text-red-500"></i>'}
                            </div>
                            <!-- Bars -->
                            <div class="w-20 space-y-1 z-20 mt-1">
                                <div class="w-full h-1.5 bg-slate-900 rounded-full overflow-hidden border border-white/10">
                                    <div id="hp-${unit.instanceId}" class="h-full ${isHero ? 'bg-gradient-to-r from-green-400 to-emerald-500' : 'bg-gradient-to-r from-red-500 to-orange-500'} hp-fill" style="width: ${(unit.hp/unit.maxHp)*100}%"></div>
                                </div>
                                <div class="w-full h-1 bg-slate-900 rounded-full overflow-hidden border border-white/10">
                                    <div id="cd-${unit.instanceId}" class="h-full bg-yellow-400" style="width: 0%"></div>
                                </div>
                            </div>
                            <!-- Damage Numbers Container -->
                            <div id="dmg-${unit.instanceId}" class="absolute -top-10 left-1/2 transform -translate-x-1/2 pointer-events-none w-24 text-center z-30"></div>
                        `;
                        container.appendChild(el);
                    });
                };

                if (hCont.children.length !== battleState.heroes.length) syncUnits(hCont, battleState.heroes, true);
                if (eCont.children.length !== battleState.enemies.length) syncUnits(eCont, battleState.enemies, false);
            },

            updateBattleBars: () => {
                const update = (list) => {
                    list.forEach(u => {
                        const hpBar = document.getElementById(`hp-${u.instanceId}`);
                        const cdBar = document.getElementById(`cd-${u.instanceId}`);
                        if(hpBar) hpBar.style.width = `${Math.max(0, (u.hp/u.maxHp)*100)}%`;
                        if(cdBar) cdBar.style.width = `${(u.cd/u.maxCd)*100}%`;
                        
                        const unitEl = document.getElementById(`unit-${u.instanceId}`);
                        if(unitEl) unitEl.style.opacity = u.hp <= 0 ? 0.3 : 1;
                        if(unitEl) unitEl.style.filter = u.hp <= 0 ? 'grayscale(100%)' : 'none';
                    });
                };
                update(battleState.heroes);
                update(battleState.enemies);
            },

            showDamage: (id, amount, type) => {
                const container = document.getElementById(`dmg-${id}`);
                if (!container) return;
                
                const el = document.createElement('div');
                el.innerText = amount;
                el.className = `text-lg font-black drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] absolute w-full text-center ${type === 'crit' ? 'text-yellow-300 text-2xl scale-125' : 'text-white'}`;
                el.style.animation = "float 0.8s ease-out forwards";
                container.appendChild(el);
                
                setTimeout(() => el.remove(), 700);
            },

            animateAttack: (id, type) => {
                const el = document.getElementById(`unit-${id}`);
                if (!el) return;
                
                const moveClass = type === 'hero' ? 'translate-x-12' : '-translate-x-12';
                const rotateClass = type === 'hero' ? 'rotate-12' : '-rotate-12';
                el.classList.add('transform', moveClass, rotateClass);
                setTimeout(() => {
                    el.classList.remove(moveClass, rotateClass);
                }, 150);
            },

            log: (msg, color="text-pink-300") => {
                const log = document.getElementById('battle-log');
                const line = document.createElement('div');
                line.className = color;
                line.innerText = `> ${msg}`;
                log.prepend(line);
                if (log.children.length > 20) log.lastChild.remove();
            }
        };

        window.onload = game.init;
    </script>
</body>
</html>